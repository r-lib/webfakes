<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>OAuth2.0 webfakes apps • webfakes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="OAuth2.0 webfakes apps">
<meta name="robots" content="noindex">
<script defer data-domain="webfakes.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">webfakes</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.3.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/introduction.html">Intro</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/how-to.html">How-to</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/glossary.html">Glossary</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../httpbin.html">The builtin httpbin app's API</a></li>
    <li><a class="dropdown-item" href="../articles/oauth.html">OAuth2.0 webfakes apps</a></li>
    <li><a class="dropdown-item" href="../articles/internals.html">Webfakes internals</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/webfakes/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>OAuth2.0 webfakes apps</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/webfakes/blob/main/vignettes/oauth.Rmd" class="external-link"><code>vignettes/oauth.Rmd</code></a></small>
      <div class="d-none name"><code>oauth.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://webfakes.r-lib.org/">webfakes</a></span><span class="op">)</span></span></code></pre></div>
<!-- does not work with in-body style options -->
<p>The webfakes package comes with two fake apps that allow to imitate
the OAuth2.0 flow in your test cases. (See <a href="https://aaronparecki.com/oauth-2-simplified/" class="external-link">Aaron Parecki’s
tutorial</a> for a good introduction to OAuth2.0.) One app
(<code><a href="../reference/oauth2_resource_app.html">oauth2_resource_app()</a></code>) is the API server that serves both
as the resource and provides authorization.
<code><a href="../reference/oauth2_third_party_app.html">oauth2_third_party_app()</a></code> plays the role of the third-party
app. They are useful when testing or demonstrating code handling
OAuth2.0 authorization, token caching, etc. in a package. The apps can
be used in your tests directly, or you could adapt one or both of them
to better mimic a particular OAuth2.0 flow.</p>
<p>In this vignette, we shall look at how to implement a flow using both
apps, or the server app together with httr’s OAuth tools. In both cases
we shall use the httr package as HTTP client. We shall end with a case
study for OAuth2.0 testing. For an example using the curl package
instead, look at the test file <code>test-oauth.R</code> of webfakes
instead.</p>
<div class="section level2">
<h2 id="the-oauth2-0-resource-and-authorization-server">The OAuth2.0 resource and authorization server<a class="anchor" aria-label="anchor" href="#the-oauth2-0-resource-and-authorization-server"></a>
</h2>
<p>First we need to create the resource server, which also performs the
authorization, and we create variables holding its different URLs.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">templog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rsapp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/oauth2_resource_app.html">oauth2_resource_app</a></span><span class="op">(</span></span>
<span>    refresh_duration <span class="op">=</span> <span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>,</span>
<span>    access_duration <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>  <span class="op">)</span>,</span>
<span>  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">regi_url</span> <span class="op">&lt;-</span> <span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/register"</span><span class="op">)</span></span>
<span><span class="va">auth_url</span> <span class="op">&lt;-</span> <span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/authorize"</span><span class="op">)</span></span>
<span><span class="va">toke_url</span> <span class="op">&lt;-</span> <span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/token"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rsapp</span></span>
<span><span class="co">#&gt; &lt;webfakes_app_process&gt;</span></span>
<span><span class="co">#&gt; state:</span></span>
<span><span class="co">#&gt;   live</span></span>
<span><span class="co">#&gt; auto_start:</span></span>
<span><span class="co">#&gt;   TRUE</span></span>
<span><span class="co">#&gt; process id:</span></span>
<span><span class="co">#&gt;   9569</span></span>
<span><span class="co">#&gt; http url:</span></span>
<span><span class="co">#&gt;   http://127.0.0.1:45795/</span></span>
<span><span class="co">#&gt; fields and methods:</span></span>
<span><span class="co">#&gt;   get_app()              # get the app object</span></span>
<span><span class="co">#&gt;   get_port()             # query (first) port of the app</span></span>
<span><span class="co">#&gt;   get_ports()            # query all ports of the app</span></span>
<span><span class="co">#&gt;   get_state()            # query web server process state</span></span>
<span><span class="co">#&gt;   local_env(envvars)     # set temporary environment variables</span></span>
<span><span class="co">#&gt;   start()                # start the app</span></span>
<span><span class="co">#&gt;   url(path, query)       # query url for an api path</span></span>
<span><span class="co">#&gt;   stop()                 # stop web server process</span></span>
<span><span class="co">#&gt; # see ?webfakes_app_process for details</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fake-third-party-application">Fake third party application<a class="anchor" aria-label="anchor" href="#fake-third-party-application"></a>
</h2>
<div class="section level3">
<h3 id="oauth2-0-app-creation-registration">OAuth2.0 app creation &amp; registration<a class="anchor" aria-label="anchor" href="#oauth2-0-app-creation-registration"></a>
</h3>
<p>Then we create the third-party app, and we create variables holding
its different URLs.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tpapp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/oauth2_third_party_app.html">oauth2_third_party_app</a></span><span class="op">(</span><span class="st">"3P app"</span><span class="op">)</span>,</span>
<span>  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">redi_url</span> <span class="op">&lt;-</span> <span class="va">tpapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/redirect"</span><span class="op">)</span></span>
<span><span class="va">conf_url</span> <span class="op">&lt;-</span> <span class="va">tpapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/config"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tpapp</span></span>
<span><span class="co">#&gt; &lt;webfakes_app_process&gt;</span></span>
<span><span class="co">#&gt; state:</span></span>
<span><span class="co">#&gt;   live</span></span>
<span><span class="co">#&gt; auto_start:</span></span>
<span><span class="co">#&gt;   TRUE</span></span>
<span><span class="co">#&gt; process id:</span></span>
<span><span class="co">#&gt;   9582</span></span>
<span><span class="co">#&gt; http url:</span></span>
<span><span class="co">#&gt;   http://127.0.0.1:41687/</span></span>
<span><span class="co">#&gt; fields and methods:</span></span>
<span><span class="co">#&gt;   get_app()              # get the app object</span></span>
<span><span class="co">#&gt;   get_port()             # query (first) port of the app</span></span>
<span><span class="co">#&gt;   get_ports()            # query all ports of the app</span></span>
<span><span class="co">#&gt;   get_state()            # query web server process state</span></span>
<span><span class="co">#&gt;   local_env(envvars)     # set temporary environment variables</span></span>
<span><span class="co">#&gt;   start()                # start the app</span></span>
<span><span class="co">#&gt;   url(path, query)       # query url for an api path</span></span>
<span><span class="co">#&gt;   stop()                 # stop web server process</span></span>
<span><span class="co">#&gt; # see ?webfakes_app_process for details</span></span></code></pre></div>
<p>We then need to register the third-party app at the resource server.
In real life this is done by the admin of the third party app. Our fake
resource server provides an endpoint at <code>/register</code> (in
<code>regi_url</code>) to do this automatically, without user
interaction. We need to send the name of our third party app, and its
redirect URL, as query parameters.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="va">regi_url</span>,</span>
<span>  <span class="st">"?name=3P%20app"</span>,</span>
<span>  <span class="st">"&amp;redirect_uri="</span>, <span class="va">redi_url</span></span>
<span><span class="op">)</span></span>
<span><span class="va">reg_resp</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span><span class="va">reg_resp</span></span>
<span><span class="co">#&gt; Response [http://127.0.0.1:45795/register?name=3P%20app&amp;redirect_uri=http://127.0.0.1:41687/login/redirect]</span></span>
<span><span class="co">#&gt;   Date: 2025-06-24 17:07</span></span>
<span><span class="co">#&gt;   Status: 200</span></span>
<span><span class="co">#&gt;   Content-Type: application/json</span></span>
<span><span class="co">#&gt;   Size: 184 B</span></span>
<span><span class="va">regdata</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">reg_resp</span><span class="op">)</span></span>
<span><span class="va">regdata</span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; $name[[1]]</span></span>
<span><span class="co">#&gt; [1] "3P app"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $client_id</span></span>
<span><span class="co">#&gt; $client_id[[1]]</span></span>
<span><span class="co">#&gt; [1] "id-778956e248fcd15a081c745fb70273"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $client_secret</span></span>
<span><span class="co">#&gt; $client_secret[[1]]</span></span>
<span><span class="co">#&gt; [1] "secret-1d03f889c6f6381d5deec9160d280f"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $redirect_uri</span></span>
<span><span class="co">#&gt; $redirect_uri[[1]]</span></span>
<span><span class="co">#&gt; [1] "http://127.0.0.1:41687/login/redirect"</span></span></code></pre></div>
<p>The resource app replies with the client id and the client secret.
We’ll use them to authenticate the third party app. In real life they
are included in the config of the third party app by its admin. Our
third party app has an API endpoint, <code>/login/config</code> (already
in <code>conf_url</code>) to configure them.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">auth_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  auth_url <span class="op">=</span> <span class="va">auth_url</span>,</span>
<span>  token_url <span class="op">=</span> <span class="va">toke_url</span>,</span>
<span>  client_id <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  client_secret <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/POST.html" class="external-link">POST</a></span><span class="op">(</span></span>
<span>  <span class="va">conf_url</span>,</span>
<span>  body <span class="op">=</span> <span class="va">auth_data</span>,</span>
<span>  encode <span class="op">=</span> <span class="st">"json"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Response [http://127.0.0.1:41687/login/config]</span></span>
<span><span class="co">#&gt;   Date: 2025-06-24 17:07</span></span>
<span><span class="co">#&gt;   Status: 200</span></span>
<span><span class="co">#&gt;   Content-Type: application/json</span></span>
<span><span class="co">#&gt;   Size: 41 B</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-oauth2-0-dance">The OAuth2.0 dance<a class="anchor" aria-label="anchor" href="#the-oauth2-0-dance"></a>
</h3>
<p>Now a user can go to the login URL of the third party app,
<code>/login</code> in our fake app, to authenticate. To start the web
page from R, you can run</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/browseURL.html" class="external-link">browseURL</a></span><span class="op">(</span><span class="va">tpapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The third party app now has a token, that it can use to authenticate
to the resource app. See the <code>test-oauth.R</code> file within
webfakes to see how to do this part programmatically, without a
browser.</p>
<p>By default our fake third party app saves the token(s) into a local
variable, and also returns in JSON, so you can see that in the
browser:</p>
<pre><code><span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "access_token": "token-c6be45eee35844e7ec1d6ada44bc15",</span></span>
<span><span class="co">#&gt;   "expiry": 10,</span></span>
<span><span class="co">#&gt;   "refresh_token": "refresh-token-ee3f1285a6f4585e9f410375e0512d"</span></span>
<span><span class="co">#&gt; }</span></span></code></pre>
<p>If you want to change this behavior, you can define the
<code>redirect_hook</code> function in the third party app. For
example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thirdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_third_party_app.html">oauth2_third_party_app</a></span><span class="op">(</span><span class="st">"3P app"</span><span class="op">)</span></span>
<span><span class="va">thirdp</span><span class="op">$</span><span class="va">redirect_hook</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span>, <span class="va">tokens</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">$</span></span>
<span>    <span class="fu">set_status</span><span class="op">(</span><span class="fl">200L</span><span class="op">)</span><span class="op">$</span></span>
<span>    <span class="fu">send</span><span class="op">(</span><span class="st">"Authentication complete, return to R!"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">tpapp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span></span>
<span>  <span class="va">thirdp</span>,</span>
<span>  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">redi_url2</span> <span class="op">&lt;-</span> <span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/redirect"</span><span class="op">)</span></span>
<span><span class="va">conf_url2</span> <span class="op">&lt;-</span> <span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/config"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tpapp2</span></span>
<span><span class="co">#&gt; &lt;webfakes_app_process&gt;</span></span>
<span><span class="co">#&gt; state:</span></span>
<span><span class="co">#&gt;   live</span></span>
<span><span class="co">#&gt; auto_start:</span></span>
<span><span class="co">#&gt;   TRUE</span></span>
<span><span class="co">#&gt; process id:</span></span>
<span><span class="co">#&gt;   9596</span></span>
<span><span class="co">#&gt; http url:</span></span>
<span><span class="co">#&gt;   http://127.0.0.1:34923/</span></span>
<span><span class="co">#&gt; fields and methods:</span></span>
<span><span class="co">#&gt;   get_app()              # get the app object</span></span>
<span><span class="co">#&gt;   get_port()             # query (first) port of the app</span></span>
<span><span class="co">#&gt;   get_ports()            # query all ports of the app</span></span>
<span><span class="co">#&gt;   get_state()            # query web server process state</span></span>
<span><span class="co">#&gt;   local_env(envvars)     # set temporary environment variables</span></span>
<span><span class="co">#&gt;   start()                # start the app</span></span>
<span><span class="co">#&gt;   url(path, query)       # query url for an api path</span></span>
<span><span class="co">#&gt;   stop()                 # stop web server process</span></span>
<span><span class="co">#&gt; # see ?webfakes_app_process for details</span></span>
<span></span>
<span><span class="va">url2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="va">regi_url</span>,</span>
<span>  <span class="st">"?name=3P%20app2"</span>,</span>
<span>  <span class="st">"&amp;redirect_uri="</span>, <span class="va">redi_url2</span></span>
<span><span class="op">)</span></span>
<span><span class="va">reg_resp2</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">url2</span><span class="op">)</span></span>
<span><span class="va">reg_resp2</span></span>
<span><span class="co">#&gt; Response [http://127.0.0.1:45795/register?name=3P%20app2&amp;redirect_uri=http://127.0.0.1:34923/login/redirect]</span></span>
<span><span class="co">#&gt;   Date: 2025-06-24 17:07</span></span>
<span><span class="co">#&gt;   Status: 200</span></span>
<span><span class="co">#&gt;   Content-Type: application/json</span></span>
<span><span class="co">#&gt;   Size: 185 B</span></span>
<span><span class="va">regdata2</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">reg_resp2</span><span class="op">)</span></span>
<span><span class="va">regdata2</span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; $name[[1]]</span></span>
<span><span class="co">#&gt; [1] "3P app2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $client_id</span></span>
<span><span class="co">#&gt; $client_id[[1]]</span></span>
<span><span class="co">#&gt; [1] "id-c0298badb0bce7b4d1452dda3ce06e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $client_secret</span></span>
<span><span class="co">#&gt; $client_secret[[1]]</span></span>
<span><span class="co">#&gt; [1] "secret-8c211555bd983d0e50f87c0406a63e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $redirect_uri</span></span>
<span><span class="co">#&gt; $redirect_uri[[1]]</span></span>
<span><span class="co">#&gt; [1] "http://127.0.0.1:34923/login/redirect"</span></span>
<span><span class="va">auth_data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  auth_url <span class="op">=</span> <span class="va">auth_url</span>,</span>
<span>  token_url <span class="op">=</span> <span class="va">toke_url</span>,</span>
<span>  client_id <span class="op">=</span> <span class="va">regdata2</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  client_secret <span class="op">=</span> <span class="va">regdata2</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/POST.html" class="external-link">POST</a></span><span class="op">(</span></span>
<span>  <span class="va">conf_url2</span>,</span>
<span>  body <span class="op">=</span> <span class="va">auth_data2</span>,</span>
<span>  encode <span class="op">=</span> <span class="st">"json"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Response [http://127.0.0.1:34923/login/config]</span></span>
<span><span class="co">#&gt;   Date: 2025-06-24 17:07</span></span>
<span><span class="co">#&gt;   Status: 200</span></span>
<span><span class="co">#&gt;   Content-Type: application/json</span></span>
<span><span class="co">#&gt;   Size: 41 B</span></span></code></pre></div>
<p>Then again you can authenticate at the new app with</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/browseURL.html" class="external-link">browseURL</a></span><span class="op">(</span><span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Authentication complete, return to R!</span></span></code></pre>
<p>The fake third party app also has an endpoint to return the saved
tokens:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/locals"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $access_token</span></span>
<span><span class="co">#&gt; [1] "token-08e1470fb2bbfa9216925390655281"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $expiry</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh_token</span></span>
<span><span class="co">#&gt; [1] "refresh-token-f70b06b589156b9b5d462b040c500c"</span></span></code></pre></div>
<p>Now the third-party app can get data on your behalf (the whole goal
of OAuth!) — it could also post data on your behalf if the resource app
had endpoints for that.</p>
<p>For example the <code>/data</code> endpoint of the third party app
queries the resource app and needs authentication. If you run the
following without the OAuth dance, your access is denied. But now it
works fine:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resp_data</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/data"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">resp_data</span></span>
<span><span class="co">#&gt; Response [http://127.0.0.1:34923/data]</span></span>
<span><span class="co">#&gt;   Date: 2025-06-24 17:07</span></span>
<span><span class="co">#&gt;   Status: 200</span></span>
<span><span class="co">#&gt;   Content-Type: application/json</span></span>
<span><span class="co">#&gt;   Size: 24 B</span></span>
<span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">resp_data</span>, as <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span></span>
<span><span class="co">#&gt; No encoding supplied: defaulting to UTF-8.</span></span>
<span><span class="co">#&gt; [1] "{\"data\":[\"top secret!\"]}"</span></span></code></pre></div>
<p>In real life, access by the third-party app might be limited to some
scopes, but the fake apps shipped with webfakes do not handle that.</p>
</div>
</div>
<div class="section level2">
<h2 id="the-fake-resource-server-and-httr">The fake resource server and httr<a class="anchor" aria-label="anchor" href="#the-fake-resource-server-and-httr"></a>
</h2>
<p>When you use httr’s OAuth tool, there’s some gymnastics happening as
R is playing the role of a third-party app via httr and httpuv (to
listen to the redirect URI).</p>
<div class="section level3">
<h3 id="oauth2-0-app-creation-registration-1">OAuth2.0 app creation &amp; registration<a class="anchor" aria-label="anchor" href="#oauth2-0-app-creation-registration-1"></a>
</h3>
<p>What’s crucial here is setting <code><a href="https://httr.r-lib.org/reference/oauth_callback.html" class="external-link">httr::oauth_callback()</a></code> as
redirect URI, which is what you do when creating an app for an R package
that uses OAuth2.0 to authenticate to a resource server.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="va">regi_url</span>,</span>
<span>  <span class="st">"?name=3P%20app2"</span>,</span>
<span>  <span class="st">"&amp;redirect_uri="</span>, <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_callback.html" class="external-link">oauth_callback</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">reg_resp3</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">url3</span><span class="op">)</span></span>
<span><span class="va">reg_resp3</span></span>
<span><span class="co">#&gt; Response [http://127.0.0.1:45795/register?name=3P%20app2&amp;redirect_uri=http://localhost:1410/]</span></span>
<span><span class="co">#&gt;   Date: 2025-06-24 17:07</span></span>
<span><span class="co">#&gt;   Status: 200</span></span>
<span><span class="co">#&gt;   Content-Type: application/json</span></span>
<span><span class="co">#&gt;   Size: 170 B</span></span>
<span><span class="va">regdata3</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">reg_resp3</span><span class="op">)</span></span>
<span><span class="va">regdata3</span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; $name[[1]]</span></span>
<span><span class="co">#&gt; [1] "3P app2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $client_id</span></span>
<span><span class="co">#&gt; $client_id[[1]]</span></span>
<span><span class="co">#&gt; [1] "id-f01feb678674422b09f33246e69490"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $client_secret</span></span>
<span><span class="co">#&gt; $client_secret[[1]]</span></span>
<span><span class="co">#&gt; [1] "secret-e842dabe3d2a7cb500813fba43805e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $redirect_uri</span></span>
<span><span class="co">#&gt; $redirect_uri[[1]]</span></span>
<span><span class="co">#&gt; [1] "http://localhost:1410/"</span></span></code></pre></div>
<p>Now we set the registration data on the third-party app.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">app</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_app.html" class="external-link">oauth_app</a></span><span class="op">(</span></span>
<span>  <span class="st">"3P app2"</span>,</span>
<span>  key <span class="op">=</span> <span class="va">regdata3</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  secret <span class="op">=</span> <span class="va">regdata3</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  redirect_uri <span class="op">=</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_callback.html" class="external-link">oauth_callback</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_endpoint.html" class="external-link">oauth_endpoint</a></span><span class="op">(</span></span>
<span>  authorize <span class="op">=</span> <span class="va">auth_url</span>,</span>
<span>  access <span class="op">=</span> <span class="va">toke_url</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can launch the token creation.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_httr_login.html">oauth2_httr_login</a></span><span class="op">(</span></span>
<span>  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth2.0_token.html" class="external-link">oauth2.0_token</a></span><span class="op">(</span><span class="va">endpoint</span>, <span class="va">app</span>, cache <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Waiting for authentication in browser...</span></span>
<span><span class="co">#&gt; Press Esc/Ctrl + C to abort</span></span>
<span><span class="co">#&gt; Authentication complete.</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">token</span></span>
<span><span class="co">#&gt; &lt;Token&gt;</span></span>
<span><span class="co">#&gt; &lt;oauth_endpoint&gt;</span></span>
<span><span class="co">#&gt;  authorize: http://127.0.0.1:45795/authorize</span></span>
<span><span class="co">#&gt;  access:    http://127.0.0.1:45795/token</span></span>
<span><span class="co">#&gt; &lt;oauth_app&gt; 3P app2</span></span>
<span><span class="co">#&gt;   key:    id-f01feb678674422b09f33246e69490</span></span>
<span><span class="co">#&gt;   secret: &lt;hidden&gt;</span></span>
<span><span class="co">#&gt; &lt;credentials&gt; access_token, expiry, refresh_token</span></span>
<span><span class="co">#&gt; ---</span></span></code></pre></div>
<p>Without the token, the query to the resource server fails:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/data"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Response [http://127.0.0.1:45795/data]</span></span>
<span><span class="co">#&gt;   Date: 2025-06-24 17:07</span></span>
<span><span class="co">#&gt;   Status: 401</span></span>
<span><span class="co">#&gt;   Content-Type: text/plain</span></span>
<span><span class="co">#&gt;   Size: 20 B</span></span></code></pre></div>
<p>With the token, it is successful. httr also automatically refreshes
the token if needed.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span></span>
<span>  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/data"</span><span class="op">)</span>, config <span class="op">=</span> <span class="va">token</span><span class="op">)</span>,</span>
<span>  as <span class="op">=</span> <span class="st">"text"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; No encoding supplied: defaulting to UTF-8.</span></span>
<span><span class="co">#&gt; [1] "{\"data\":[\"top secret!\"]}"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<div class="section level3">
<h3 id="applications">Applications<a class="anchor" aria-label="anchor" href="#applications"></a>
</h3>
<p>With these apps, or only the resource server app, you can now test
your code that helps users create and store an OAuth2.0 token.</p>
<p>Like all webfakes apps, OAuth2.0 apps are extensible: you can add
your own endpoints and middleware to it. E.g. here we add logging via
<code><a href="../reference/mw_log.html">mw_log()</a></code> and a new endpoint.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rsapp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_resource_app.html">oauth2_resource_app</a></span><span class="op">(</span></span>
<span>  refresh_duration <span class="op">=</span> <span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>,</span>
<span>  access_duration <span class="op">=</span> <span class="fl">10L</span></span>
<span><span class="op">)</span></span>
<span><span class="va">logfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"oauth-rs-"</span>, fileext <span class="op">=</span> <span class="st">".log"</span><span class="op">)</span></span>
<span><span class="va">rsapp2</span><span class="op">$</span><span class="fu">use</span><span class="op">(</span><span class="fu"><a href="../reference/mw_log.html">mw_log</a></span><span class="op">(</span>stream <span class="op">=</span> <span class="va">logfile</span><span class="op">)</span>, .first <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">rsapp2</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/docs"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">$</span></span>
<span>    <span class="fu">set_status</span><span class="op">(</span><span class="fl">200L</span><span class="op">)</span><span class="op">$</span></span>
<span>    <span class="fu">send</span><span class="op">(</span><span class="st">"See vignette('oauth', package = 'webfakes')"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rsapp2_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span></span>
<span>  <span class="va">rsapp2</span>,</span>
<span>  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If you want to customize one of the apps or both apps a lot, it might
make sense to use their source code as starting point or
inspiration.</p>
</div>
<div class="section level3">
<h3 id="debugging">Debugging<a class="anchor" aria-label="anchor" href="#debugging"></a>
</h3>
<p>See the <a href="https://r-lib.github.io/webfakes/dev/articles/how-to.html#how-can-i-debug-an-app-" class="external-link">usual
debugging advice for webfakes apps</a>. In particular, you can add the
<code><a href="../reference/mw_log.html">mw_log()</a></code> middleware to write the log of the app to a file,
like we did above.</p>
<p>The resource app has a <code>/locals</code> endpoint, that returns
all data stored in the app, this includes the tokens and the refresh
tokens:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span></span>
<span>  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/locals"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $apps</span></span>
<span><span class="co">#&gt; $apps[[1]]</span></span>
<span><span class="co">#&gt; $apps[[1]]$name</span></span>
<span><span class="co">#&gt; [1] "3P app"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[1]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-778956e248fcd15a081c745fb70273"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[1]]$client_secret</span></span>
<span><span class="co">#&gt; [1] "secret-1d03f889c6f6381d5deec9160d280f"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[1]]$redirect_uri</span></span>
<span><span class="co">#&gt; [1] "http://127.0.0.1:41687/login/redirect"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[2]]</span></span>
<span><span class="co">#&gt; $apps[[2]]$name</span></span>
<span><span class="co">#&gt; [1] "3P app2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[2]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-c0298badb0bce7b4d1452dda3ce06e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[2]]$client_secret</span></span>
<span><span class="co">#&gt; [1] "secret-8c211555bd983d0e50f87c0406a63e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[2]]$redirect_uri</span></span>
<span><span class="co">#&gt; [1] "http://127.0.0.1:34923/login/redirect"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[3]]</span></span>
<span><span class="co">#&gt; $apps[[3]]$name</span></span>
<span><span class="co">#&gt; [1] "3P app2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[3]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-f01feb678674422b09f33246e69490"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[3]]$client_secret</span></span>
<span><span class="co">#&gt; [1] "secret-e842dabe3d2a7cb500813fba43805e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $apps[[3]]$redirect_uri</span></span>
<span><span class="co">#&gt; [1] "http://localhost:1410/"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access</span></span>
<span><span class="co">#&gt; $access[[1]]</span></span>
<span><span class="co">#&gt; $access[[1]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-778956e248fcd15a081c745fb70273"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[1]]$token</span></span>
<span><span class="co">#&gt; [1] "token-c6be45eee35844e7ec1d6ada44bc15"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[1]]$expiry</span></span>
<span><span class="co">#&gt; [1] "2025-06-24 17:07:46"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[2]]</span></span>
<span><span class="co">#&gt; $access[[2]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-c0298badb0bce7b4d1452dda3ce06e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[2]]$token</span></span>
<span><span class="co">#&gt; [1] "token-08e1470fb2bbfa9216925390655281"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[2]]$expiry</span></span>
<span><span class="co">#&gt; [1] "2025-06-24 17:07:46"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[3]]</span></span>
<span><span class="co">#&gt; $access[[3]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-f01feb678674422b09f33246e69490"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[3]]$token</span></span>
<span><span class="co">#&gt; [1] "token-1f46a0366717828ac5cc842c163a31"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $access[[3]]$expiry</span></span>
<span><span class="co">#&gt; [1] "2025-06-24 17:07:47"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh</span></span>
<span><span class="co">#&gt; $refresh[[1]]</span></span>
<span><span class="co">#&gt; $refresh[[1]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-778956e248fcd15a081c745fb70273"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[1]]$token</span></span>
<span><span class="co">#&gt; [1] "refresh-token-ee3f1285a6f4585e9f410375e0512d"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[1]]$expiry</span></span>
<span><span class="co">#&gt; [1] "2093-07-12 20:21:43"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[2]]</span></span>
<span><span class="co">#&gt; $refresh[[2]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-c0298badb0bce7b4d1452dda3ce06e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[2]]$token</span></span>
<span><span class="co">#&gt; [1] "refresh-token-f70b06b589156b9b5d462b040c500c"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[2]]$expiry</span></span>
<span><span class="co">#&gt; [1] "2093-07-12 20:21:43"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[3]]</span></span>
<span><span class="co">#&gt; $refresh[[3]]$client_id</span></span>
<span><span class="co">#&gt; [1] "id-f01feb678674422b09f33246e69490"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[3]]$token</span></span>
<span><span class="co">#&gt; [1] "refresh-token-81d2b2f09bcf64302605ab6a9750b3"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $refresh[[3]]$expiry</span></span>
<span><span class="co">#&gt; [1] "2093-07-12 20:21:44"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="case-study-for-oauth2-0-testing">Case study for OAuth2.0 testing<a class="anchor" aria-label="anchor" href="#case-study-for-oauth2-0-testing"></a>
</h2>
<p>Consider a package that has a function that uses OAuth2.0 to access
GitHub. In this section we’ll show how you can use webfakes to test this
function.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gh_base</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"FAKE_GH_API_BASE"</span>, <span class="st">"https://api.github.com"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">gh_oauth_base</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span></span>
<span>    <span class="st">"FAKE_GH_AUTH_BASE"</span>,</span>
<span>    <span class="st">"https://github.com/login/oauth"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">gh_repos</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ghapp</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_app.html" class="external-link">oauth_app</a></span><span class="op">(</span></span>
<span>    <span class="st">"gh_repos"</span>,</span>
<span>    key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GH_CLIENT_ID"</span><span class="op">)</span>,</span>
<span>    secret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GH_CLIENT_SECRET"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">endpoints</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_endpoint.html" class="external-link">oauth_endpoint</a></span><span class="op">(</span></span>
<span>    base_url <span class="op">=</span> <span class="fu">gh_oauth_base</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    request <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    authorize <span class="op">=</span> <span class="st">"authorize"</span>,</span>
<span>    access <span class="op">=</span> <span class="st">"access_token"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">gh_token</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth2.0_token.html" class="external-link">oauth2.0_token</a></span><span class="op">(</span></span>
<span>    <span class="va">endpoints</span>,</span>
<span>    <span class="va">ghapp</span>,</span>
<span>    cache <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">httr_token</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/config.html" class="external-link">config</a></span><span class="op">(</span>token <span class="op">=</span> <span class="va">gh_token</span><span class="op">)</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu">gh_base</span><span class="op">(</span><span class="op">)</span>, <span class="st">"/user/repos?visibility=public"</span><span class="op">)</span>,</span>
<span>    <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html" class="external-link">add_headers</a></span><span class="op">(</span>Accept <span class="op">=</span> <span class="st">"application/vnd.github.v3+json"</span><span class="op">)</span>,</span>
<span>    config <span class="op">=</span> <span class="va">httr_token</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/stop_for_status.html" class="external-link">stop_for_status</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span></span>
<span>  <span class="va">json</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">response</span>, as <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span></span>
<span>  <span class="va">repos</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">json</span>, simplifyVector <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">repos</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="va">r</span><span class="op">$</span><span class="va">full_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code>gh_repos()</code> uses an OAuth2.0 app to get a token from
GitHub, and then uses that token to authenticate and list the public
repositories of the current user. In a real package you would probably
get the token in a separate function, cache it, and re-use it for
multiple queries. (Also, you don’t actually need authorization for
listing public repositories, so this is a somewhat artificial
example.)</p>
<p>To run this function, you would need to register an app at <a href="https://github.com/settings/developers" class="external-link uri">https://github.com/settings/developers</a>. Make sure that
you set <code>http://localhost:1410</code> as the authorization callback
URL. You can set the other options as you please. Then in R set the
<code>GH_CLIENT_ID</code> and <code>GH_CLIENT_SECRET</code> environment
variables to the client id and client secret of the app:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>GH_CLIENT_ID <span class="op">=</span> <span class="st">"&lt;your client id here&gt;"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>GH_CLIENT_SECRET <span class="op">=</span> <span class="st">"&lt;your client secret here&gt;"</span><span class="op">)</span></span></code></pre></div>
<p>When you run this function it opens a Window in your browser, where
you can authorize the app to access your public information on GitHub.
For the subsequent runs that browser window still opens, but the
authorization is automatic. In a real package you could cache the
OAuth2.0 tokens on the machine, e.g. using the keyring package.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gh_repos</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Waiting for authentication in browser...</span></span>
<span><span class="co">#&gt; Press Esc/Ctrl + C to abort</span></span>
<span><span class="co">#&gt; Authentication complete.</span></span>
<span><span class="co">#&gt;  [1] "gaborcsardi/altlist"     "gaborcsardi/argufy"     </span></span>
<span><span class="co">#&gt;  [3] "gaborcsardi/async"       "gaborcsardi/disposables"</span></span>
<span><span class="co">#&gt;  [5] "gaborcsardi/dotenv"      "gaborcsardi/falsy"      </span></span>
<span><span class="co">#&gt;  [7] "gaborcsardi/franc"       "gaborcsardi/ISA"        </span></span>
<span><span class="co">#&gt;  [9] "gaborcsardi/keypress"    "gaborcsardi/lpSolve"    </span></span>
<span><span class="co">#&gt; [11] "gaborcsardi/macBriain"   "gaborcsardi/maxygen"    </span></span>
<span><span class="co">#&gt; [13] "gaborcsardi/MISO"        "gaborcsardi/msgtools"   </span></span>
<span><span class="co">#&gt; [15] "gaborcsardi/notifier"    "gaborcsardi/odbc"       </span></span>
<span><span class="co">#&gt; [17] "gaborcsardi/parr"        "gaborcsardi/parsedate"  </span></span>
<span><span class="co">#&gt; [19] "gaborcsardi/prompt"      "gaborcsardi/r-font"     </span></span>
<span><span class="co">#&gt; [21] "gaborcsardi/r-source"    "gaborcsardi/rcorpora"   </span></span>
<span><span class="co">#&gt; [23] "gaborcsardi/roxygenlabs" "gaborcsardi/sankey"     </span></span>
<span><span class="co">#&gt; [25] "gaborcsardi/secret"      "gaborcsardi/spark"      </span></span>
<span><span class="co">#&gt; [27] "gaborcsardi/standalones"</span></span></code></pre>
<p>Let’s write a test case now for <code>gh_repos()</code>. We will use
<code>oauth2_repource_app()</code> to fake GitHub.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"gh_repos"</span>, <span class="op">{</span></span>
<span>  <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html" class="external-link">skip_on_cran</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">fake_app</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_resource_app.html">oauth2_resource_app</a></span><span class="op">(</span>token_endpoint <span class="op">=</span> <span class="st">"/access_token"</span><span class="op">)</span></span>
<span>  <span class="va">fake_app</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/user/repos"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">app</span><span class="op">$</span><span class="fu">is_authorized</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">res</span><span class="op">$</span><span class="fu">send_json</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>full_name <span class="op">=</span> <span class="st">"user/repo1"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>full_name <span class="op">=</span> <span class="st">"user/repo2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">fake_proc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/local_app_process.html">local_app_process</a></span><span class="op">(</span></span>
<span>    <span class="va">fake_app</span>,</span>
<span>    opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># register the app to our fake GH server</span></span>
<span>  <span class="va">reg_url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="va">fake_proc</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/register"</span><span class="op">)</span>,</span>
<span>    <span class="st">"?name=gh_repos&amp;redirect_uri=http://localhost:1410/"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">regdata</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">reg_url</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_envvar.html" class="external-link">local_envvar</a></span><span class="op">(</span></span>
<span>    GH_CLIENT_ID <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    GH_CLIENT_SECRET <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    FAKE_GH_API_BASE <span class="op">=</span> <span class="va">fake_proc</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    FAKE_GH_AUTH_BASE <span class="op">=</span> <span class="va">fake_proc</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu">webfakes</span><span class="fu">::</span><span class="fu"><a href="../reference/oauth2_httr_login.html">oauth2_httr_login</a></span><span class="op">(</span></span>
<span>    <span class="fu">gh_repos</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">ret</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"user/repo1"</span>, <span class="st">"user/repo2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> 🎉</span></span></code></pre></div>
<p>Some important points about this test case:</p>
<ul>
<li><p>Since the test case will fail if port 1410 is taken, it is safer
to skip it on CRAN.</p></li>
<li>
<p><code>fake_app</code> is a webfakes app, that is almost the same
as <code><a href="../reference/oauth2_resource_app.html">oauth2_resource_app()</a></code>, with two changes.</p>
<ul>
<li>The first is the we change the end point for getting a token to
<code>/access_token</code> because that is what GitHub uses.</li>
<li>The second is that we also add the <code>/user/repos</code>
endpoint. This endpoint needs authorization, this is why it calls
<code>app$is_authorized()</code>, which fails without it, and the app
returns 401 Access denied.</li>
</ul>
</li>
<li><p><code>fake_proc</code> is the app process that runs our fake GH
app. Always run the fake OAuth2.0 apps with multiple threads.</p></li>
<li><p>Our fake GitHub app has an endpoint to register the app we are
testing. We need to send the app’s name and the correct redirect URI,
and <code>fake_app</code> will reply with a fake client id and client
secret.</p></li>
<li><p>We set <code>GH_CLIENT_ID</code> and
<code>GH_CLIENT_SECRET</code> to the fake ones we just got from
<code>fake_app</code>.</p></li>
<li><p>We also redirect <code>gh_token()</code> to the fake app, by
setting <code>FAKE_GH_API_BASE</code> and
<code>FAKE_GH_AUTH_BASE</code>.</p></li>
<li><p>Now if we call <code>gh_repos()</code>, it will connect to our
fake app. We also need to make sure that httr can log in to the fake
app, without a browser interaction. The
<code><a href="../reference/oauth2_httr_login.html">webfakes::oauth2_httr_login()</a></code> wrapper takes care of that.
It runs an HTTP client in a background process, to perform the log
in.</p></li>
<li><p>If the background process in
<code><a href="../reference/oauth2_httr_login.html">webfakes::oauth2_httr_login()</a></code> fails to log in for some
reason, the test code might freeze. This is another good reason to skip
this test on CRAN.</p></li>
<li><p><code><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages()</a></code> suppresses the (harmless) httr
messages about the authorization.</p></li>
<li><p>The test case does have a lot of boilerplate to set up and manage
the fake apps. Note that you can refactor this code into its own helper
function, that starts up the fake app sub-process on demand in a helper
file. That way you can reuse it for multiple test files and test
cases.</p></li>
</ul>
<p>This test case ensures that the OAuth2.0 setup in
<code>gh_repos()</code> stays correct.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
