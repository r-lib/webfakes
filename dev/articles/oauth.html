<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OAuth2.0 webfakes apps • webfakes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="OAuth2.0 webfakes apps">
<meta property="og:description" content="webfakes">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">webfakes</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/introduction.html">Intro</a>
</li>
<li>
  <a href="../articles/how-to.html">How-to</a>
</li>
<li>
  <a href="../articles/glossary.html">Glossary</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../httpbin.html">The builtin httpbin app's API</a>
    </li>
    <li>
      <a href="../articles/internals.html">Webfakes internals</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/webfakes/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="oauth_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>OAuth2.0 webfakes apps</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/webfakes/blob/master/vignettes/oauth.Rmd"><code>vignettes/oauth.Rmd</code></a></small>
      <div class="hidden name"><code>oauth.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-lib.github.io/webfakes">webfakes</a></span><span class="op">)</span></code></pre></div>
<p>The webfakes package comes with two fake apps that allow to imitate the OAuth2.0 flow in your test cases. (See <a href="https://aaronparecki.com/oauth-2-simplified/">Aaron Parecki’s tutorial</a> for a good introduction to OAuth2.0.) One app (<code><a href="../reference/oauth2_resource_app.html">oauth2_resource_app()</a></code>) is the API server that serves both as the resource and provides authorization. <code><a href="../reference/oauth2_third_party_app.html">oauth2_third_party_app()</a></code> plays the role of the third-party app. They are useful when testing or demonstrating code handling OAuth2.0 authorization, token caching, etc. in a package. The apps can be used in your tests directly, or you could adapt one or both of them to better mimic a particular OAuth2.0 flow.</p>
<p>In this vignette, we shall look at how to implement a flow using both apps, or the server app together with httr’s OAuth tools. In both cases we shall use the httr package as HTTP client. We shall end with a case study for OAuth2.0 testing. For an example using the curl package instead, look at the test file <code>test-oauth.R</code> of webfakes instead.</p>
<div id="the-oauth2-0-resource-and-authorization-server" class="section level2">
<h2 class="hasAnchor">
<a href="#the-oauth2-0-resource-and-authorization-server" class="anchor"></a>The OAuth2.0 resource and authorization server</h2>
<p>First we need to create the resource server, which also performs the authorization, and we create variables holding its different URLs.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">templog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">rsapp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/oauth2_resource_app.html">oauth2_resource_app</a></span><span class="op">(</span>
    refresh_duration <span class="op">=</span> <span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>,
    access_duration <span class="op">=</span> <span class="fl">10L</span>,
  <span class="op">)</span>,
  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">regi_url</span> <span class="op">&lt;-</span> <span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/register"</span><span class="op">)</span>
<span class="va">auth_url</span> <span class="op">&lt;-</span> <span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/authorize"</span><span class="op">)</span>
<span class="va">toke_url</span> <span class="op">&lt;-</span> <span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/token"</span><span class="op">)</span>

<span class="va">rsapp</span>
<span class="co">#&gt; &lt;webfakes_app_process&gt;</span>
<span class="co">#&gt; state:</span>
<span class="co">#&gt;   live</span>
<span class="co">#&gt; auto_start:</span>
<span class="co">#&gt;   TRUE</span>
<span class="co">#&gt; process id:</span>
<span class="co">#&gt;   2849</span>
<span class="co">#&gt; http url:</span>
<span class="co">#&gt;   http://127.0.0.1:49613/</span>
<span class="co">#&gt; fields and methods:</span>
<span class="co">#&gt;   get_app()              # get the app object</span>
<span class="co">#&gt;   get_port()             # query port of the app</span>
<span class="co">#&gt;   get_state()            # query web server process state</span>
<span class="co">#&gt;   local_env(envvars)     # set temporary environment variables</span>
<span class="co">#&gt;   start()                # start the app</span>
<span class="co">#&gt;   url(path, query)       # query url for an api path</span>
<span class="co">#&gt;   stop()                 # stop web server process</span>
<span class="co">#&gt; # see ?webfakes_app_process for details</span></code></pre></div>
</div>
<div id="fake-third-party-application" class="section level2">
<h2 class="hasAnchor">
<a href="#fake-third-party-application" class="anchor"></a>Fake third party application</h2>
<div id="oauth2-0-app-creation-registration" class="section level3">
<h3 class="hasAnchor">
<a href="#oauth2-0-app-creation-registration" class="anchor"></a>OAuth2.0 app creation &amp; registration</h3>
<p>Then we create the third-party app, and we create variables holding its different URLs.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tpapp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/oauth2_third_party_app.html">oauth2_third_party_app</a></span><span class="op">(</span><span class="st">"3P app"</span><span class="op">)</span>,
  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">redi_url</span> <span class="op">&lt;-</span> <span class="va">tpapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/redirect"</span><span class="op">)</span>
<span class="va">conf_url</span> <span class="op">&lt;-</span> <span class="va">tpapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/config"</span><span class="op">)</span>

<span class="va">tpapp</span>
<span class="co">#&gt; &lt;webfakes_app_process&gt;</span>
<span class="co">#&gt; state:</span>
<span class="co">#&gt;   live</span>
<span class="co">#&gt; auto_start:</span>
<span class="co">#&gt;   TRUE</span>
<span class="co">#&gt; process id:</span>
<span class="co">#&gt;   2853</span>
<span class="co">#&gt; http url:</span>
<span class="co">#&gt;   http://127.0.0.1:49614/</span>
<span class="co">#&gt; fields and methods:</span>
<span class="co">#&gt;   get_app()              # get the app object</span>
<span class="co">#&gt;   get_port()             # query port of the app</span>
<span class="co">#&gt;   get_state()            # query web server process state</span>
<span class="co">#&gt;   local_env(envvars)     # set temporary environment variables</span>
<span class="co">#&gt;   start()                # start the app</span>
<span class="co">#&gt;   url(path, query)       # query url for an api path</span>
<span class="co">#&gt;   stop()                 # stop web server process</span>
<span class="co">#&gt; # see ?webfakes_app_process for details</span></code></pre></div>
<p>We then need to register the third-party app at the resource server. In real life this is done by the admin of the third party app. Our fake resource server provides an endpoint at <code>/register</code> (in <code>regi_url</code>) to do this automatically, without user interaction. We need to send the name of our third party app, and its redirect URL, as query parameters.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="va">regi_url</span>,
  <span class="st">"?name=3P%20app"</span>,
  <span class="st">"&amp;redirect_uri="</span>, <span class="va">redi_url</span>
<span class="op">)</span>
<span class="va">reg_resp</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>
<span class="va">reg_resp</span>
<span class="co">#&gt; Response [http://127.0.0.1:49613/register?name=3P%20app&amp;redirect_uri=http://127.0.0.1:49614/login/redirect]</span>
<span class="co">#&gt;   Date: 2020-12-13 10:08</span>
<span class="co">#&gt;   Status: 200</span>
<span class="co">#&gt;   Content-Type: application/json</span>
<span class="co">#&gt;   Size: 184 B</span>
<span class="va">regdata</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">reg_resp</span><span class="op">)</span>
<span class="va">regdata</span>
<span class="co">#&gt; $name</span>
<span class="co">#&gt; $name[[1]]</span>
<span class="co">#&gt; [1] "3P app"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $client_id</span>
<span class="co">#&gt; $client_id[[1]]</span>
<span class="co">#&gt; [1] "id-f7ab1c304862f72dbc3b5bacc2d465"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $client_secret</span>
<span class="co">#&gt; $client_secret[[1]]</span>
<span class="co">#&gt; [1] "secret-514ae2157143b0e4b89e60fd2b4339"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $redirect_uri</span>
<span class="co">#&gt; $redirect_uri[[1]]</span>
<span class="co">#&gt; [1] "http://127.0.0.1:49614/login/redirect"</span></code></pre></div>
<p>The resource app replies with the client id and the client secret. We’ll use them to authenticate the third party app. In real life they are included in the config of the third party app by its admin. Our third party app has an API endpoint, <code>/login/config</code> (already in <code>conf_url</code>) to configure them.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">auth_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  auth_url <span class="op">=</span> <span class="va">auth_url</span>,
  token_url <span class="op">=</span> <span class="va">toke_url</span>,
  client_id <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  client_secret <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="op">)</span>

<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span>
  <span class="va">conf_url</span>,
  body <span class="op">=</span> <span class="va">auth_data</span>,
  encode <span class="op">=</span> <span class="st">"json"</span>
<span class="op">)</span>
<span class="co">#&gt; Response [http://127.0.0.1:49614/login/config]</span>
<span class="co">#&gt;   Date: 2020-12-13 10:08</span>
<span class="co">#&gt;   Status: 200</span>
<span class="co">#&gt;   Content-Type: application/json</span>
<span class="co">#&gt;   Size: 41 B</span></code></pre></div>
</div>
<div id="the-oauth2-0-dance" class="section level3">
<h3 class="hasAnchor">
<a href="#the-oauth2-0-dance" class="anchor"></a>The OAuth2.0 dance</h3>
<p>Now a user can go to the login URL of the third party app, <code>/login</code> in our fake app, to authenticate. To start the web page from R, you can run</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/browseURL.html">browseURL</a></span><span class="op">(</span><span class="va">tpapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The third party app now has a token, that it can use to authenticate to the resource app. See the <code>test-oauth.R</code> file within webfakes to see how to do this part programmatically, without a browser.</p>
<p>By default our fake third party app saves the token(s) into a local variable, and also returns in JSON, so you can see that in the browser:</p>
<pre><code>#&gt; {
#&gt;   "access_token": "token-99295fa152caa5566550a889fb24f6",
#&gt;   "expiry": 10,
#&gt;   "refresh_token": "refresh-token-1fd9c727fcc82516194810444b0dc5"
#&gt; }</code></pre>
<p>If you want to change this behavior, you can define the <code>redirect_hook</code> function in the third party app. For example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">thirdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_third_party_app.html">oauth2_third_party_app</a></span><span class="op">(</span><span class="st">"3P app"</span><span class="op">)</span>
<span class="va">thirdp</span><span class="op">$</span><span class="va">redirect_hook</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span>, <span class="va">tokens</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span><span class="op">$</span>
    <span class="fu">set_status</span><span class="op">(</span><span class="fl">200L</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">send</span><span class="op">(</span><span class="st">"Authentication complete, return to R!"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">tpapp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span>
  <span class="va">thirdp</span>,
  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">redi_url2</span> <span class="op">&lt;-</span> <span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/redirect"</span><span class="op">)</span>
<span class="va">conf_url2</span> <span class="op">&lt;-</span> <span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login/config"</span><span class="op">)</span>

<span class="va">tpapp2</span>
<span class="co">#&gt; &lt;webfakes_app_process&gt;</span>
<span class="co">#&gt; state:</span>
<span class="co">#&gt;   live</span>
<span class="co">#&gt; auto_start:</span>
<span class="co">#&gt;   TRUE</span>
<span class="co">#&gt; process id:</span>
<span class="co">#&gt;   2857</span>
<span class="co">#&gt; http url:</span>
<span class="co">#&gt;   http://127.0.0.1:49622/</span>
<span class="co">#&gt; fields and methods:</span>
<span class="co">#&gt;   get_app()              # get the app object</span>
<span class="co">#&gt;   get_port()             # query port of the app</span>
<span class="co">#&gt;   get_state()            # query web server process state</span>
<span class="co">#&gt;   local_env(envvars)     # set temporary environment variables</span>
<span class="co">#&gt;   start()                # start the app</span>
<span class="co">#&gt;   url(path, query)       # query url for an api path</span>
<span class="co">#&gt;   stop()                 # stop web server process</span>
<span class="co">#&gt; # see ?webfakes_app_process for details</span>

<span class="va">url2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="va">regi_url</span>,
  <span class="st">"?name=3P%20app2"</span>,
  <span class="st">"&amp;redirect_uri="</span>, <span class="va">redi_url2</span>
<span class="op">)</span>
<span class="va">reg_resp2</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url2</span><span class="op">)</span>
<span class="va">reg_resp2</span>
<span class="co">#&gt; Response [http://127.0.0.1:49613/register?name=3P%20app2&amp;redirect_uri=http://127.0.0.1:49622/login/redirect]</span>
<span class="co">#&gt;   Date: 2020-12-13 10:08</span>
<span class="co">#&gt;   Status: 200</span>
<span class="co">#&gt;   Content-Type: application/json</span>
<span class="co">#&gt;   Size: 185 B</span>
<span class="va">regdata2</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">reg_resp2</span><span class="op">)</span>
<span class="va">regdata2</span>
<span class="co">#&gt; $name</span>
<span class="co">#&gt; $name[[1]]</span>
<span class="co">#&gt; [1] "3P app2"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $client_id</span>
<span class="co">#&gt; $client_id[[1]]</span>
<span class="co">#&gt; [1] "id-2e42cfee9914265c3ebe59cd93a725"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $client_secret</span>
<span class="co">#&gt; $client_secret[[1]]</span>
<span class="co">#&gt; [1] "secret-62b265a0db347f67b24ad3b7cfa018"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $redirect_uri</span>
<span class="co">#&gt; $redirect_uri[[1]]</span>
<span class="co">#&gt; [1] "http://127.0.0.1:49622/login/redirect"</span>
<span class="va">auth_data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  auth_url <span class="op">=</span> <span class="va">auth_url</span>,
  token_url <span class="op">=</span> <span class="va">toke_url</span>,
  client_id <span class="op">=</span> <span class="va">regdata2</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  client_secret <span class="op">=</span> <span class="va">regdata2</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="op">)</span>

<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span>
  <span class="va">conf_url2</span>,
  body <span class="op">=</span> <span class="va">auth_data2</span>,
  encode <span class="op">=</span> <span class="st">"json"</span>
<span class="op">)</span>
<span class="co">#&gt; Response [http://127.0.0.1:49622/login/config]</span>
<span class="co">#&gt;   Date: 2020-12-13 10:08</span>
<span class="co">#&gt;   Status: 200</span>
<span class="co">#&gt;   Content-Type: application/json</span>
<span class="co">#&gt;   Size: 41 B</span></code></pre></div>
<p>Then again you can authenticate at the new app with</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/browseURL.html">browseURL</a></span><span class="op">(</span><span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/login"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Authentication complete, return to R!</code></pre>
<p>The fake third party app also has an endpoint to return the saved tokens:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/locals"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $access_token</span>
<span class="co">#&gt; [1] "token-d4504f9bddaa51c450fd9d6d7e4fd3"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $expiry</span>
<span class="co">#&gt; [1] 10</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh_token</span>
<span class="co">#&gt; [1] "refresh-token-1dd6ada89b40fdf4fb979899c2a3f7"</span></code></pre></div>
<p>Now the third-party app can get data on your behalf (the whole goal of OAuth!) — it could also post data on your behalf if the resource app had endpoints for that.</p>
<p>For example the <code>/data</code> endpoint of the third party app queries the resource app and needs authentication. If you run the following without the OAuth dance, your access is denied. But now it works fine:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp_data</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">tpapp2</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/data"</span><span class="op">)</span><span class="op">)</span>
<span class="va">resp_data</span>
<span class="co">#&gt; Response [http://127.0.0.1:49622/data]</span>
<span class="co">#&gt;   Date: 2020-12-13 10:08</span>
<span class="co">#&gt;   Status: 200</span>
<span class="co">#&gt;   Content-Type: application/json</span>
<span class="co">#&gt;   Size: 24 B</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">resp_data</span>, as <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span>
<span class="co">#&gt; No encoding supplied: defaulting to UTF-8.</span>
<span class="co">#&gt; [1] "{\"data\":[\"top secret!\"]}"</span></code></pre></div>
<p>In real life, access by the third-party app might be limited to some scopes, but the fake apps shipped with webfakes do not handle that.</p>
</div>
</div>
<div id="the-fake-resource-server-and-httr" class="section level2">
<h2 class="hasAnchor">
<a href="#the-fake-resource-server-and-httr" class="anchor"></a>The fake resource server and httr</h2>
<p>When you use httr’s OAuth tool, there’s some gymnastics happening as R is playing the role of a third-party app via httr and httpuv (to listen to the redirect URI).</p>
<div id="oauth2-0-app-creation-registration-1" class="section level3">
<h3 class="hasAnchor">
<a href="#oauth2-0-app-creation-registration-1" class="anchor"></a>OAuth2.0 app creation &amp; registration</h3>
<p>What’s crucial here is setting <code><a href="https://httr.r-lib.org/reference/oauth_callback.html">httr::oauth_callback()</a></code> as redirect URI, which is what you do when creating an app for an R package that uses OAuth2.0 to authenticate to a resource server.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">url3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="va">regi_url</span>,
  <span class="st">"?name=3P%20app2"</span>,
  <span class="st">"&amp;redirect_uri="</span>, <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_callback.html">oauth_callback</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">reg_resp3</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url3</span><span class="op">)</span>
<span class="va">reg_resp3</span>
<span class="co">#&gt; Response [http://127.0.0.1:49613/register?name=3P%20app2&amp;redirect_uri=http://localhost:1410/]</span>
<span class="co">#&gt;   Date: 2020-12-13 10:08</span>
<span class="co">#&gt;   Status: 200</span>
<span class="co">#&gt;   Content-Type: application/json</span>
<span class="co">#&gt;   Size: 170 B</span>
<span class="va">regdata3</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">reg_resp3</span><span class="op">)</span>
<span class="va">regdata3</span>
<span class="co">#&gt; $name</span>
<span class="co">#&gt; $name[[1]]</span>
<span class="co">#&gt; [1] "3P app2"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $client_id</span>
<span class="co">#&gt; $client_id[[1]]</span>
<span class="co">#&gt; [1] "id-b3ee8747f93e58577f4c8d1a705f2f"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $client_secret</span>
<span class="co">#&gt; $client_secret[[1]]</span>
<span class="co">#&gt; [1] "secret-51d2fa77254373541ec6adcfba0466"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $redirect_uri</span>
<span class="co">#&gt; $redirect_uri[[1]]</span>
<span class="co">#&gt; [1] "http://localhost:1410/"</span></code></pre></div>
<p>Now we set the registration data on the third-party app.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">app</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_app.html">oauth_app</a></span><span class="op">(</span>
  <span class="st">"3P app2"</span>,
  key <span class="op">=</span> <span class="va">regdata3</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  secret <span class="op">=</span> <span class="va">regdata3</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  redirect_uri <span class="op">=</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_callback.html">oauth_callback</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_endpoint.html">oauth_endpoint</a></span><span class="op">(</span>
  authorize <span class="op">=</span> <span class="va">auth_url</span>,
  access <span class="op">=</span> <span class="va">toke_url</span>
<span class="op">)</span></code></pre></div>
<p>Now we can launch the token creation.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_httr_login.html">oauth2_httr_login</a></span><span class="op">(</span>
  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth2.0_token.html">oauth2.0_token</a></span><span class="op">(</span><span class="va">endpoint</span>, <span class="va">app</span>, cache <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Waiting for authentication in browser...</span>
<span class="co">#&gt; Press Esc/Ctrl + C to abort</span>
<span class="co">#&gt; Authentication complete.</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token</span>
<span class="co">#&gt; &lt;Token&gt;</span>
<span class="co">#&gt; &lt;oauth_endpoint&gt;</span>
<span class="co">#&gt;  authorize: http://127.0.0.1:49613/authorize</span>
<span class="co">#&gt;  access:    http://127.0.0.1:49613/token</span>
<span class="co">#&gt; &lt;oauth_app&gt; 3P app2</span>
<span class="co">#&gt;   key:    id-b3ee8747f93e58577f4c8d1a705f2f</span>
<span class="co">#&gt;   secret: &lt;hidden&gt;</span>
<span class="co">#&gt; &lt;credentials&gt; access_token, expiry, refresh_token</span>
<span class="co">#&gt; ---</span></code></pre></div>
<p>Without the token, the query to the resource server fails:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/data"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Response [http://127.0.0.1:49613/data]</span>
<span class="co">#&gt;   Date: 2020-12-13 10:08</span>
<span class="co">#&gt;   Status: 401</span>
<span class="co">#&gt;   Content-Type: text/plain</span>
<span class="co">#&gt;   Size: 20 B</span></code></pre></div>
<p>With the token, it is successful. httr also automatically refreshes the token if needed.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span>
  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/data"</span><span class="op">)</span>, config <span class="op">=</span> <span class="va">token</span><span class="op">)</span>,
  as <span class="op">=</span> <span class="st">"text"</span>
<span class="op">)</span>
<span class="co">#&gt; No encoding supplied: defaulting to UTF-8.</span>
<span class="co">#&gt; [1] "{\"data\":[\"top secret!\"]}"</span></code></pre></div>
</div>
</div>
<div id="advanced-topics" class="section level2">
<h2 class="hasAnchor">
<a href="#advanced-topics" class="anchor"></a>Advanced topics</h2>
<div id="applications" class="section level3">
<h3 class="hasAnchor">
<a href="#applications" class="anchor"></a>Applications</h3>
<p>With these apps, or only the resource server app, you can now test your code that helps users create and store an OAuth2.0 token.</p>
<p>Like all webfakes apps, OAuth2.0 apps are extensible: you can add your own endpoints and middleware to it. E.g. here we add logging via <code><a href="../reference/mw_log.html">mw_log()</a></code> and a new endpoint.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsapp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_resource_app.html">oauth2_resource_app</a></span><span class="op">(</span>
  refresh_duration <span class="op">=</span> <span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>,
  access_duration <span class="op">=</span> <span class="fl">10L</span>
<span class="op">)</span>
<span class="va">logfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="st">"oauth-rs-"</span>, fileext <span class="op">=</span> <span class="st">".log"</span><span class="op">)</span>
<span class="va">rsapp2</span><span class="op">$</span><span class="fu">use</span><span class="op">(</span><span class="fu"><a href="../reference/mw_log.html">mw_log</a></span><span class="op">(</span>stream <span class="op">=</span> <span class="va">logfile</span><span class="op">)</span>, .first <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">rsapp2</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/docs"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span><span class="op">$</span>
    <span class="fu">set_status</span><span class="op">(</span><span class="fl">200L</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">send</span><span class="op">(</span><span class="st">"See vignette('oauth', package = 'webfakes')"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">rsapp2_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span>
  <span class="va">rsapp2</span>,
  opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>If you want to customize one of the apps or both apps a lot, it might make sense to use their source code as starting point or inspiration.</p>
</div>
<div id="debugging" class="section level3">
<h3 class="hasAnchor">
<a href="#debugging" class="anchor"></a>Debugging</h3>
<p>See the <a href="https://r-lib.github.io/webfakes/dev/articles/how-to.html#how-can-i-debug-an-app-">usual debugging advice for webfakes apps</a>. In particular, you can add the <code><a href="../reference/mw_log.html">mw_log()</a></code> middleware to write the log of the app to a file, like we did above.</p>
<p>The resource app has a <code>/locals</code> endpoint, that returns all data stored in the app, this includes the tokens and the refresh tokens:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span>
  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">rsapp</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/locals"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; $apps</span>
<span class="co">#&gt; $apps[[1]]</span>
<span class="co">#&gt; $apps[[1]]$name</span>
<span class="co">#&gt; [1] "3P app"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[1]]$client_id</span>
<span class="co">#&gt; [1] "id-f7ab1c304862f72dbc3b5bacc2d465"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[1]]$client_secret</span>
<span class="co">#&gt; [1] "secret-514ae2157143b0e4b89e60fd2b4339"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[1]]$redirect_uri</span>
<span class="co">#&gt; [1] "http://127.0.0.1:49614/login/redirect"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[2]]</span>
<span class="co">#&gt; $apps[[2]]$name</span>
<span class="co">#&gt; [1] "3P app2"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[2]]$client_id</span>
<span class="co">#&gt; [1] "id-2e42cfee9914265c3ebe59cd93a725"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[2]]$client_secret</span>
<span class="co">#&gt; [1] "secret-62b265a0db347f67b24ad3b7cfa018"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[2]]$redirect_uri</span>
<span class="co">#&gt; [1] "http://127.0.0.1:49622/login/redirect"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[3]]</span>
<span class="co">#&gt; $apps[[3]]$name</span>
<span class="co">#&gt; [1] "3P app2"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[3]]$client_id</span>
<span class="co">#&gt; [1] "id-b3ee8747f93e58577f4c8d1a705f2f"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[3]]$client_secret</span>
<span class="co">#&gt; [1] "secret-51d2fa77254373541ec6adcfba0466"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $apps[[3]]$redirect_uri</span>
<span class="co">#&gt; [1] "http://localhost:1410/"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access</span>
<span class="co">#&gt; $access[[1]]</span>
<span class="co">#&gt; $access[[1]]$client_id</span>
<span class="co">#&gt; [1] "id-f7ab1c304862f72dbc3b5bacc2d465"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[1]]$token</span>
<span class="co">#&gt; [1] "token-99295fa152caa5566550a889fb24f6"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[1]]$expiry</span>
<span class="co">#&gt; [1] "2020-12-13 10:08:20"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[2]]</span>
<span class="co">#&gt; $access[[2]]$client_id</span>
<span class="co">#&gt; [1] "id-2e42cfee9914265c3ebe59cd93a725"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[2]]$token</span>
<span class="co">#&gt; [1] "token-d4504f9bddaa51c450fd9d6d7e4fd3"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[2]]$expiry</span>
<span class="co">#&gt; [1] "2020-12-13 10:08:20"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[3]]</span>
<span class="co">#&gt; $access[[3]]$client_id</span>
<span class="co">#&gt; [1] "id-b3ee8747f93e58577f4c8d1a705f2f"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[3]]$token</span>
<span class="co">#&gt; [1] "token-d11247fca276aa5f90b7297615cb22"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $access[[3]]$expiry</span>
<span class="co">#&gt; [1] "2020-12-13 10:08:22"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh</span>
<span class="co">#&gt; $refresh[[1]]</span>
<span class="co">#&gt; $refresh[[1]]$client_id</span>
<span class="co">#&gt; [1] "id-f7ab1c304862f72dbc3b5bacc2d465"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[1]]$token</span>
<span class="co">#&gt; [1] "refresh-token-1fd9c727fcc82516194810444b0dc5"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[1]]$expiry</span>
<span class="co">#&gt; [1] "2088-12-31 13:22:17"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[2]]</span>
<span class="co">#&gt; $refresh[[2]]$client_id</span>
<span class="co">#&gt; [1] "id-2e42cfee9914265c3ebe59cd93a725"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[2]]$token</span>
<span class="co">#&gt; [1] "refresh-token-1dd6ada89b40fdf4fb979899c2a3f7"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[2]]$expiry</span>
<span class="co">#&gt; [1] "2088-12-31 13:22:17"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[3]]</span>
<span class="co">#&gt; $refresh[[3]]$client_id</span>
<span class="co">#&gt; [1] "id-b3ee8747f93e58577f4c8d1a705f2f"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[3]]$token</span>
<span class="co">#&gt; [1] "refresh-token-e1a686d3c9fce47d75c7e31b9a4fdb"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $refresh[[3]]$expiry</span>
<span class="co">#&gt; [1] "2088-12-31 13:22:19"</span></code></pre></div>
</div>
</div>
<div id="case-study-for-oauth2-0-testing" class="section level2">
<h2 class="hasAnchor">
<a href="#case-study-for-oauth2-0-testing" class="anchor"></a>Case study for OAuth2.0 testing</h2>
<p>Consider a package that has a function that uses OAuth2.0 to access GitHub. In this section we’ll show how you can use webfakes to test this function.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gh_base</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"FAKE_GH_API_BASE"</span>, <span class="st">"https://api.github.com"</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">gh_oauth_base</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span>
    <span class="st">"FAKE_GH_AUTH_BASE"</span>,
    <span class="st">"https://github.com/login/oauth"</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="va">gh_repos</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ghapp</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_app.html">oauth_app</a></span><span class="op">(</span>
    <span class="st">"gh_repos"</span>,
    key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"GH_CLIENT_ID"</span><span class="op">)</span>,
    secret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"GH_CLIENT_SECRET"</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="va">endpoints</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_endpoint.html">oauth_endpoint</a></span><span class="op">(</span>
    base_url <span class="op">=</span> <span class="fu">gh_oauth_base</span><span class="op">(</span><span class="op">)</span>,
    request <span class="op">=</span> <span class="cn">NULL</span>,
    authorize <span class="op">=</span> <span class="st">"authorize"</span>,
    access <span class="op">=</span> <span class="st">"access_token"</span>
  <span class="op">)</span>
  <span class="va">gh_token</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth2.0_token.html">oauth2.0_token</a></span><span class="op">(</span>
    <span class="va">endpoints</span>,
    <span class="va">ghapp</span>,
    cache <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
  <span class="va">httr_token</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/config.html">config</a></span><span class="op">(</span>token <span class="op">=</span> <span class="va">gh_token</span><span class="op">)</span>
  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">gh_base</span><span class="op">(</span><span class="op">)</span>, <span class="st">"/user/repos?visibility=public"</span><span class="op">)</span>,
    <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op">(</span>Accept <span class="op">=</span> <span class="st">"application/vnd.github.v3+json"</span><span class="op">)</span>,
    config <span class="op">=</span> <span class="va">httr_token</span>
  <span class="op">)</span>
  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/stop_for_status.html">stop_for_status</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span>
  <span class="va">json</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, as <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span>
  <span class="va">repos</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json</span>, simplifyVector <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">repos</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="va">r</span><span class="op">$</span><span class="va">full_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><code>gh_repos()</code> uses an OAuth2.0 app to get a token from GitHub, and then uses that token to authenticate and list the public repositories of the current user. In a real package you would probably get the token in a separate function, cache it, and re-use it for multiple queries. (Also, you don’t actually need authorization for listing public repositories, so this is a somewhat artificial example.)</p>
<p>To run this function, you would need to register an app at <a href="https://github.com/settings/developers" class="uri">https://github.com/settings/developers</a>. Make sure that you set <code>http://localhost:1410</code> as the authorization callback URL. You can set the other options as you please. Then in R set the <code>GH_CLIENT_ID</code> and <code>GH_CLIENT_SECRET</code> environment variables to the client id and client secret of the app:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>GH_CLIENT_ID <span class="op">=</span> <span class="st">"&lt;your client id here&gt;"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>GH_CLIENT_SECRET <span class="op">=</span> <span class="st">"&lt;your client secret here&gt;"</span><span class="op">)</span></code></pre></div>
<p>When you run this function it opens a Window in your browser, where you can authorize the app to access your public information on GitHub. For the subsequent runs that browser window still opens, but the authorization is automatic. In a real package you could cache the OAuth2.0 tokens on the machine, e.g. using the keyring package.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">gh_repos</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Waiting for authentication in browser...
#&gt; Press Esc/Ctrl + C to abort
#&gt; Authentication complete.
#&gt;  [1] "gaborcsardi/altlist"     "gaborcsardi/argufy"     
#&gt;  [3] "gaborcsardi/async"       "gaborcsardi/disposables"
#&gt;  [5] "gaborcsardi/dotenv"      "gaborcsardi/falsy"      
#&gt;  [7] "gaborcsardi/franc"       "gaborcsardi/ISA"        
#&gt;  [9] "gaborcsardi/keypress"    "gaborcsardi/lpSolve"    
#&gt; [11] "gaborcsardi/macBriain"   "gaborcsardi/maxygen"    
#&gt; [13] "gaborcsardi/MISO"        "gaborcsardi/msgtools"   
#&gt; [15] "gaborcsardi/notifier"    "gaborcsardi/odbc"       
#&gt; [17] "gaborcsardi/parr"        "gaborcsardi/parsedate"  
#&gt; [19] "gaborcsardi/prompt"      "gaborcsardi/r-font"     
#&gt; [21] "gaborcsardi/r-source"    "gaborcsardi/rcorpora"   
#&gt; [23] "gaborcsardi/roxygenlabs" "gaborcsardi/sankey"     
#&gt; [25] "gaborcsardi/secret"      "gaborcsardi/spark"      
#&gt; [27] "gaborcsardi/standalones"</code></pre>
<p>Let’s write a test case now for <code>gh_repos()</code>. We will use <code>oauth2_repource_app()</code> to fake GitHub.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"gh_repos"</span>, <span class="op">{</span>
  <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">fake_app</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth2_resource_app.html">oauth2_resource_app</a></span><span class="op">(</span>token_endpoint <span class="op">=</span> <span class="st">"/access_token"</span><span class="op">)</span>
  <span class="va">fake_app</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/user/repos"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">app</span><span class="op">$</span><span class="fu">is_authorized</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>
    <span class="va">res</span><span class="op">$</span><span class="fu">send_json</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>full_name <span class="op">=</span> <span class="st">"user/repo1"</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>full_name <span class="op">=</span> <span class="st">"user/repo2"</span><span class="op">)</span>
    <span class="op">)</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

  <span class="va">fake_proc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/local_app_process.html">local_app_process</a></span><span class="op">(</span>
    <span class="va">fake_app</span>,
    opts <span class="op">=</span> <span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
  <span class="op">)</span>

  <span class="co"># register the app to our fake GH server</span>
  <span class="va">reg_url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="va">fake_proc</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/register"</span><span class="op">)</span>,
    <span class="st">"?name=gh_repos&amp;redirect_uri=http://localhost:1410/"</span>
  <span class="op">)</span>
  <span class="va">regdata</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">reg_url</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_envvar.html">local_envvar</a></span><span class="op">(</span>
    GH_CLIENT_ID <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_id</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
    GH_CLIENT_SECRET <span class="op">=</span> <span class="va">regdata</span><span class="op">$</span><span class="va">client_secret</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
    FAKE_GH_API_BASE <span class="op">=</span> <span class="va">fake_proc</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span>,
    FAKE_GH_AUTH_BASE <span class="op">=</span> <span class="va">fake_proc</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>

  <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="fu">webfakes</span><span class="fu">::</span><span class="fu"><a href="../reference/oauth2_httr_login.html">oauth2_httr_login</a></span><span class="op">(</span>
    <span class="fu">gh_repos</span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>
  <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">ret</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"user/repo1"</span>, <span class="st">"user/repo2"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed 🌈</span></code></pre></div>
<p>Some important points about this test case:</p>
<ul>
<li><p>Since the test case will fail if port 1410 is taken, it is safer to skip it on CRAN.</p></li>
<li>
<p><code>fake_app</code> is a webfakes app, that is almost the same as <code><a href="../reference/oauth2_resource_app.html">oauth2_resource_app()</a></code>, with two changes.</p>
<ul>
<li>The first is the we change the end point for getting a token to <code>/access_token</code> because that is what GitHub uses.</li>
<li>The second is that we also add the <code>/user/repos</code> endpoint. This endpoint needs authorization, this is why it calls <code>app$is_authorized()</code>, which fails without it, and the app returns 401 Access denied.</li>
</ul>
</li>
<li><p><code>fake_proc</code> is the app process that runs our fake GH app. Always run the fake OAuth2.0 apps with multiple threads.</p></li>
<li><p>Our fake GitHub app has an endpoint to register the app we are testing. We need to send the app’s name and the correct redirect URI, and <code>fake_app</code> will reply with a fake client id and client secret.</p></li>
<li><p>We set <code>GH_CLIENT_ID</code> and <code>GH_CLIENT_SECRET</code> to the fake ones we just got from <code>fake_app</code>.</p></li>
<li><p>We also redirect <code>gh_token()</code> to the fake app, by setting <code>FAKE_GH_API_BASE</code> and <code>FAKE_GH_AUTH_BASE</code>.</p></li>
<li><p>Now if we call <code>gh_repos()</code>, it will connect to our fake app. We also need to make sure that httr can log in to the fake app, without a browser interaction. The <code><a href="../reference/oauth2_httr_login.html">webfakes::oauth2_httr_login()</a></code> wrapper takes care of that. It runs an HTTP client in a background process, to perform the log in.</p></li>
<li><p>If the background process in <code><a href="../reference/oauth2_httr_login.html">webfakes::oauth2_httr_login()</a></code> fails to log in for some reason, the test code might freeze. This is another good reason to skip this test on CRAN.</p></li>
<li><p><code><a href="https://rdrr.io/r/base/message.html">suppressMessages()</a></code> suppresses the (harmless) httr messages about the authorization.</p></li>
<li><p>The test case does have a lot of boilerplate to set up and manage the fake apps. Note that you can refactor this code into its own helper function, that starts up the fake app sub-process on demand in a helper file. That way you can reuse it for multiple test files and test cases.</p></li>
</ul>
<p>This test case ensures that the OAuth2.0 setup in <code>gh_repos()</code> stays correct.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/gaborcsardi">Gábor Csárdi</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
