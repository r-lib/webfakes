<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="webfakes">
<title>Happy HTTP testing with webfakes • webfakes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.7/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.7/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Happy HTTP testing with webfakes">
<meta property="og:description" content="webfakes">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="webfakes.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">webfakes</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/introduction.html">Intro</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/how-to.html">How-to</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/glossary.html">Glossary</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../httpbin.html">The builtin httpbin app's API</a>
    <a class="dropdown-item" href="../articles/oauth.html">OAuth2.0 webfakes apps</a>
    <a class="dropdown-item" href="../articles/internals.html">Webfakes internals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/webfakes/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Happy HTTP testing with webfakes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/webfakes/blob/HEAD/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="what-is-webfakes">What is webfakes?<a class="anchor" aria-label="anchor" href="#what-is-webfakes"></a>
</h2>
<p>Webfakes is an R package that can spin up web servers on your machine
to facilitate testing R code. R code that needs an HTTP connection is
not trivial to test:</p>
<ul>
<li>Connectivity problems might prevent the tests from accessing the web
server.</li>
<li>The web server might need authentication, and it is not easy to
convey login information to the test suite in a secure way.</li>
<li>The web server might have rate limits, i.e, it limits the number of
queries per hour or day, causing some spurious test failures.</li>
<li>You might want to test in non-normal conditions, e.g. with low
bandwidth, or when the client is rate limited. These conditions don’t
normally happen on the web server and they are hard to trigger.</li>
</ul>
<p>With webfakes you can easily start a custom web app, that is running
on the local machine.</p>
<ul>
<li>Webfakes does not need a network connection.</li>
<li>Webfakes does not need authentication. Well, unless you want it
to.</li>
<li>Webfakes does not have rate limits.</li>
<li>Webfakes can simulate low bandwidth, or a broken connection.</li>
</ul>
</div>
<div class="section level2">
<h2 id="webfakes-vs-mocking">Webfakes vs mocking<a class="anchor" aria-label="anchor" href="#webfakes-vs-mocking"></a>
</h2>
<p>Mocking is a general technique to mimic the behavior of a function or
object that is needed in test case. In the case of HTTP requests, this
typically means that both the request and its response are recorded when
the tests run the first time, and saved to disk. Subsequent test runs
intercept the HTTP requests, match them against the recorded requests
and then replay the corresponding recorded response. See for example the
<a href="https://docs.ropensci.org/vcr/" class="external-link">vcr</a> and <a href="https://enpiar.com/r/httptest/" class="external-link">httptest</a> R packages.</p>
<p>The advantages of using your own webfakes server, over mocking:</p>
<ul>
<li>Simpler infrastructure. No separate recording and replaying phases,
no recorded files. No request matching.</li>
<li>You can use any web client you want. E.g. curl and base R’s HTTP
functions do not explicitly support mocking currently.</li>
<li>No need to worry about sensitive information in recorded requests or
responses.</li>
<li>Often easier to use when testing non-normal conditions, e.g. errors
that are hard to trigger, low bandwidth, or rate limits.</li>
<li>Works if you stream data from a HTTP connection, instead of reading
the whole response at once.</li>
<li>You can reuse the same app for multiple tests, in multiple
packages.</li>
<li>Easier to use for tests that require multiple rounds of
requests.</li>
<li>Comes with a built-in <code>https://httpbin.org</code> compatible
app, chances are, you don’t even need to write your testing app, just
start writing tests right away.</li>
<li>Better test writing experience. This is subjective, and your mileage
may vary.</li>
</ul>
</div>
<div class="section level2">
<h2 id="webfakes-vs-the-real-api">Webfakes vs the real API<a class="anchor" aria-label="anchor" href="#webfakes-vs-the-real-api"></a>
</h2>
<ul>
<li>No network needed. No more <code>skip_if_offline()</code>.</li>
<li>Much faster.</li>
<li>No rate limits. But you can simulate one if you want to.</li>
<li>You can write your custom app.</li>
<li>Simulate low bandwidth or a broken connection.</li>
</ul>
</div>
<div class="section level2">
<h2 id="webfakes-vs-httpbin-org">Webfakes vs httpbin.org<a class="anchor" aria-label="anchor" href="#webfakes-vs-httpbin-org"></a>
</h2>
<ul>
<li>No network needed. No more <code>skip_if_offline()</code>.</li>
<li>Much faster.</li>
<li>You can use the built-in <code><a href="../reference/httpbin_app.html">webfakes::httpbin_app()</a></code> app,
so it is easy to switch from httpbin.org.</li>
<li>You can write your custom app, httpbin.org might not have what you
need.</li>
</ul>
</div>
<div class="section level2">
<h2 id="using-webfakeshttpbin_app-with-testthat">Using <code>webfakes::httpbin_app()</code> with testthat<a class="anchor" aria-label="anchor" href="#using-webfakeshttpbin_app-with-testthat"></a>
</h2>
<p>You can use testthat’s setup files. You start the app in a setup file
and also register a teardown expression for it.
<code><a href="../reference/local_app_process.html">local_app_process()</a></code> can do both in one go. Your
<code>tests/testthat/setup-http.R</code> may look like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">http</span> <span class="op">&lt;-</span> <span class="fu">webfakes</span><span class="fu">::</span><span class="fu"><a href="../reference/local_app_process.html">local_app_process</a></span><span class="op">(</span></span>
<span>  <span class="fu">webfakes</span><span class="fu">::</span><span class="fu"><a href="../reference/httpbin_app.html">httpbin_app</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .local_envir <span class="op">=</span> <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/teardown_env.html" class="external-link">teardown_env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>(Before testthat 3.0.0, you had to write the teardown expression in a
<code>tests/testthat/teardown-http.R</code> file. That still works, but
a single setup file is considered to be better practice, see <a href="https://testthat.r-lib.org/articles/test-fixtures.html" class="external-link">this
testthat vignette</a>.)</p>
<p>In the test cases you can query the <code>http</code> app process to
get the URLs you need to connect to:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"fails on 404"</span>, <span class="op">{</span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="va">http</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/status/404"</span><span class="op">)</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>  <span class="fu">expect_error</span><span class="op">(</span></span>
<span>    <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/stop_for_status.html" class="external-link">stop_for_status</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"http_404"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; Test passed</span></span></code></pre></div>
<p>When writing your tests interactively, you may create a
<code>http</code> app process in the global environment, for
convenience. You can <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code> your
<code>setup-http.R</code> file for this. Alternatively, you can start
the app process in a helper file. See “How do I start the app when
writing the tests?” just below.</p>
<p>You can also create a web server for a test file, or even for a
single test case. See <code><a href="../articles/how-to.html">vignette("how-to")</a></code> for details
how.</p>
</div>
<div class="section level2">
<h2 id="writing-apps">Writing apps<a class="anchor" aria-label="anchor" href="#writing-apps"></a>
</h2>
<p>If the builtin <code><a href="../reference/httpbin_app.html">httpbin_app()</a></code> is not appropriate for your
tests, you can write your own app. You can also extend the
<code><a href="../reference/httpbin_app.html">httpbin_app()</a></code> app, if you don’t want to start from
scratch.</p>
<p>You create a new app with <code><a href="../reference/new_app.html">new_app()</a></code>. This returns an
object with methods to add middleware and API endpoints to it. For
example, a simple app that returns the current time in JSON would look
like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu">webfakes</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app.html">new_app</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">time</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/time"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">$</span><span class="fu">send_json</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Now you can start this app on a random port using
<code>web$listen()</code>. Alternatively, you can start it in a
subprocess with <code><a href="../reference/new_app_process.html">new_app_process()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">web</span> <span class="op">&lt;-</span> <span class="fu">webfakes</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "http://127.0.0.1:42569/"</span></span></code></pre></div>
<p>Use <code>web$url()</code> to query the URL of the app. For
example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url</span> <span class="op">&lt;-</span> <span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/time"</span><span class="op">)</span></span>
<span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $time</span></span>
<span><span class="co">#&gt; [1] "2023-10-24 12:31:15"</span></span></code></pre></div>
<p><code>web$stop()</code> stops the app and the subprocess as well:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">web</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">web</span><span class="op">$</span><span class="fu">get_state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "not running"</span></span></code></pre></div>
<p><code><a href="../reference/local_app_process.html">local_app_process()</a></code> is similar to
<code><a href="../reference/new_app_process.html">new_app_process()</a></code>, but it stops the server process at the
end of the calling block. This means that the process is automatically
cleaned up at the end of a <code>test_that()</code> block or at the end
of the test file.</p>
<p>You can create your app at the beginning of your test file. Or, if
you want to use the same app in multiple test files, use a <a href="https://testthat.r-lib.org/reference/test_file.html#special-files" class="external-link">testthat
helper file</a>. Sometimes it useful if your users can create and use
your test app, for example to create reproducible examples. You can
include a (possibly internal) function in your package, that creates the
app.</p>
<p>See <code>?new_app()</code>, <code>?new_app_process()</code> and
<code><a href="../reference/local_app_process.html">?local_app_process</a></code> for more details.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a>, RStudio, Pbc..</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>
