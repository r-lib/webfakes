<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy HTTP testing with presser â€¢ presser</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Happy HTTP testing with presser">
<meta property="og:description" content="presser">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">presser</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/introduction.html">Intro</a>
</li>
<li>
  <a href="../articles/how-to.html">How-to</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../httpbin.html">The builtin httpbin app's API</a>
    </li>
    <li>
      <a href="../articles/internals.html">Presser internals</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/presser/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Happy HTTP testing with presser</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/presser/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<div id="what-is-presser" class="section level2">
<h2 class="hasAnchor">
<a href="#what-is-presser" class="anchor"></a>What is presser?</h2>
<p>Presser is an R package that can spin up web servers your machine to facilitate testing R code. R code that needs an HTTP connection is not trivial to test:</p>
<ul>
<li>Connectivity problems might prevent the tests from accessing the web server.</li>
<li>The web server might need authentication, and it is not easy to convey login information to the test suite in a secure way.</li>
<li>The web server might have rate limits, i.e, it limits the number of queries per hour or day, causing some spurious test failures.</li>
<li>You might want to test in non-normal conditions, e.g.Â with low bandwidth, or when the client is rate limited. These conditions donâ€™t normally happen on the web server and they are hard to trigger.</li>
</ul>
<p>With presser you can easily start a custom web app, that is running on the local machine.</p>
<ul>
<li>Presser does not need a network connection.</li>
<li>Presser does not need authentication. Well, unless you want it to.</li>
<li>Presser does not have rate limits.</li>
<li>Presser can simulate low bandwidth, or a broken connection.</li>
</ul>
</div>
<div id="presser-vs-mocking" class="section level2">
<h2 class="hasAnchor">
<a href="#presser-vs-mocking" class="anchor"></a>Presser vs mocking</h2>
<p>Mocking is a general technique to mimic the behavior of a function or object that is needed in test case. In the case of HTTP requests, this typically means that both the request and its response are recorded when the tests run the first time, and saved to disk. Subsequent test runs intercept the HTTP requests, match them against the recorded requests and then replay the corresponding recorded response. See for example the <a href="https://docs.ropensci.org/vcr/">vcr</a> and <a href="https://enpiar.com/r/httptest/">httptest</a> R packages.</p>
<p>The advantages of using your own presser server, over mocking:</p>
<ul>
<li>Simpler infrastructure. No separate recording and replaying phases, no recorded files. No request matching.</li>
<li>You can use any web client you want. E.g. curl and base Râ€™s HTTP functions do not explicitly support mocking currently.</li>
<li>No need to worry about sensitive information in recorded requests or responses.</li>
<li>Often easier to use when testing non-normal conditions, e.g.Â errors that are hard to trigger, low bandwidth, or rate limits.</li>
<li>Works if you stream data from a HTTP connection, instead of reading the whole response at once.</li>
<li>You can reuse the same app for multiple tests, in multiple packages.</li>
<li>Easier to use for tests that require multiple rounds of requests.</li>
<li>Comes with a built-in <a href="https://httpbin.org" class="uri">https://httpbin.org</a> compatible app, chances are, you donâ€™t even need to write your testing app, just start writing tests right away.</li>
<li>Better test writing experience. This is subjective, and your mileage may vary.</li>
</ul>
</div>
<div id="presser-vs-the-real-api" class="section level2">
<h2 class="hasAnchor">
<a href="#presser-vs-the-real-api" class="anchor"></a>Presser vs the real API</h2>
<ul>
<li>No network needed. No more <code>skip_if_offline()</code>.</li>
<li>Much faster.</li>
<li>No rate limits. But you can simulate one if you want to.</li>
<li>You can write your custom app.</li>
<li>Simulate low bandwidth or a broken connection.</li>
</ul>
</div>
<div id="presser-vs-httpbin-org" class="section level2">
<h2 class="hasAnchor">
<a href="#presser-vs-httpbin-org" class="anchor"></a>Presser vs httpbin.org</h2>
<ul>
<li>No network needed. No more <code>skip_if_offline()</code>.</li>
<li>Much faster.</li>
<li>You can use the built-in <code><a href="../reference/httpbin_app.html">presser::httpbin_app()</a></code> app, so it is easy to switch from httpbin.org.</li>
<li>You can write your custom app, httpbin.org might not have what you need.</li>
</ul>
</div>
<div id="using-presserhttpbin_app-with-testthat" class="section level2">
<h2 class="hasAnchor">
<a href="#using-presserhttpbin_app-with-testthat" class="anchor"></a>Using <code>presser::httpbin_app()</code> with testthat</h2>
<p>You can use testthatâ€™s setup files. You start the app in a setup file and also register a teardown expression for it. <code><a href="../reference/local_app_process.html">local_app_process()</a></code> can do both in one go. Your <code>tests/testthat/setup-http.R</code> may look like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">http</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/local_app_process.html">local_app_process</a></span><span class="op">(</span>
  <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/httpbin_app.html">httpbin_app</a></span><span class="op">(</span><span class="op">)</span>,
  .local_envir <span class="op">=</span> <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/teardown_env.html">teardown_env</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>(Before testthat 3.0.0, you had to write the teardown expression in a <code>tests/testthat/teardown-http.R</code> file. That still works, but a single setup file is considered to be better practice, see <a href="https://testthat.r-lib.org/articles/test-fixtures.html">this testthat vignette</a>.)</p>
<p>In the test cases you can query the <code>http</code> app process to get the URLs you need to connect to:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">test_that</span><span class="op">(</span><span class="st">"fails on 404"</span>, <span class="op">{</span>
  <span class="va">url</span> <span class="op">&lt;-</span> <span class="va">http</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/status/404"</span><span class="op">)</span>
  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>
  <span class="fu">expect_error</span><span class="op">(</span>
    <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/stop_for_status.html">stop_for_status</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span>,
    class <span class="op">=</span> <span class="st">"http_404"</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed ðŸŽ‰</span></code></pre></div>
<p>When writing your tests interactively, you may create a <code>http</code> app process in the global environment, for convenience. You can <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> your <code>setup-http.R</code> file for this.</p>
<p>You can also create a web server for a test file, or even for a single test case. See the How-to for details how.</p>
</div>
<div id="writing-apps" class="section level2">
<h2 class="hasAnchor">
<a href="#writing-apps" class="anchor"></a>Writing apps</h2>
<p>If the builtin <code><a href="../reference/httpbin_app.html">httpbin_app()</a></code> is not appropriate for your tests, you can write your own app. You can also extend the <code><a href="../reference/httpbin_app.html">httpbin_app()</a></code> app, if you donâ€™t want to start from scratch.</p>
<p>You create a new app with <code><a href="../reference/new_app.html">new_app()</a></code>. This returns an object with methods to add middleware and API endpoints to it. For example, a simple app that returns the current time in JSON would look like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app.html">new_app</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">time</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/time"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span><span class="op">$</span><span class="fu">send_json</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Now you can start this app on a random port using <code>web$listen()</code>. Alternatively, you can start it in a subprocess with <code><a href="../reference/new_app_process.html">new_app_process()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">web</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>
<span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "http://127.0.0.1:49576/"</span></code></pre></div>
<p>Use <code>web$url()</code> to query the URL of the app. For example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">url</span> <span class="op">&lt;-</span> <span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/time"</span><span class="op">)</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $time</span>
<span class="co">#&gt; [1] "2020-11-16 14:34:04"</span></code></pre></div>
<p><code>web$stop()</code> stops the app and the subprocess as well:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">web</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span>
<span class="va">web</span><span class="op">$</span><span class="fu">get_state</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "not running"</span></code></pre></div>
<p><code><a href="../reference/local_app_process.html">local_app_process()</a></code> is similar to <code><a href="../reference/new_app_process.html">new_app_process()</a></code>, but it stops the server process at the end of the calling block. This means that the process is automatically cleaned up at the end of a <code>test_that()</code> block or at the end of the test file.</p>
<p>You can create your app at the beginning of your test file. Or, if you want to use the same app in multiple test files, use a testthat helper file. Sometimes it useful if your users can create and use your test app, for example to create reproducible examples. You can include a (possibly internal) function in your package, that creates the app.</p>
<p>See <code>?new_app()</code>, <code>?new_app_process()</code> and <code><a href="../reference/local_app_process.html">?local_app_process</a></code> for more details.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/gaborcsardi">GÃ¡bor CsÃ¡rdi</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
